# 3장) 다른 개발자와 코드 계약

1장에서 소개한 코드 품질 핵심 요소 네 가지 중 위 두 가지와 연관이 있다.

1. 예측 가능한 코드를 작성하라
2. 코드를 오용하기 어렵게 만들라

⇒ 이 원칙들 자체가 다른 사람과 협업을 고려한 것이다.

### 우리가 작성한 코드는 남이 작성한 코드를 기반으로 될 것이고, 남이 작성할 코드에는 내 코드를 기반으로 될 것이다.

코드를 작성할 때 다음 세 가지를 기억하자

- 내게 명백하다고 남에게도 명백한 코드가 아니다
    - 내가 코드를 작성했기 때문에 나는 전후 관계가 모두 이해된 상태이므로 명백해 보일 수 있지만, 남에게는 아닐 수 있다. → 그러므로, 항상 이해하기 쉽고 코드 자체가 설명이 되는 코드를 작성해라.
- 다른 개발자가 실수로 내 코드를 망가뜨릴 수도 있다.
    - 코드는 계속 변한다. 그러므로, 내 코드를 다른 개발자가 나중에 수정할 수도 있다. 이때, 코드에 대한 이해가 부족한 상태로 내 코드를 수정하면, 망가질 수도 있다.
    - 그래서, 테스트 코드가 필요하다. 테스트 코드가 실패하면 애초에 병합이 안되도록 막아버리는 기법을 사용하면 되기 때문임.
- 시간이 지나면 내가 내 코드를 모른다
    - 그러므로, 배경지식이 없는 사람도 이해하기 쉬운 코드를 작성해야 한다. 그게 곧 나를 위한 것임.

### 내  코드를 남이 이해하기 쉽게 하는 방법

남의 코드를 볼 때 이해해야할 것들로는 아래 것들이 있다.

- 특정 상황에서 어떤 함수를 호출해야 하는지
- 클래스가 무엇을 나타내고, 언제 사용되어야 하는지
- 어떤 값을 인수로 사용해야 하는지
- 코드가 수행하는 동작이 무엇인지
- 어떤 값을 반환하는지

위의 것들을 이해하기 위해 개발자들은 다음 것들을 볼것임

- 함수, 클래스 등의 이름을 본다
- 매개변수나 반환값 등의 데이터 유형을 볼 것이다.
- 주석문이나 문서를 읽을 것임
    - 문서도 좀 애매하긴 함. 개발자들이 이걸 읽을거란 보장을 못함. 읽어도 잘못 해석할 수 있음. 또한, 내가 이 문서를 읽는 개발자들의 배경지식 정도를 예측할 수 없다. 마지막으로, 문서 업데이트를 해줘야한다..
- ~~직접 물어보기~~
    - 유용할 수도 있지만, 설명하는 사람의 시간을 오래 뺏을 수 있고, 그 사람이 휴가나 이직으로 없으면 문제임.
- ~~구현코드를 직접 읽어보기~~
    - 추상화 계층의 이점들을 싹 다 부정하는 방법임. 비현실적이다.

⇒ 이 중 위 세가지 정도만 실제 개발 환경에서 허용할만한 범주임.

# 코드 계약

계약에 의한 프로그래밍

⇒ 다른 코드 간 상호작용을  마치 계약처럼 사용하는 철학임.

- 선결 조건: 코드 호출 전 사실이어야 하는 것. 시스템의 필요한 상태, 필요한 입력값들 등
- 사후 조건: 코드 실행 후 사실이어야 하는 것. 바뀐 시스템의 상태, 반환값 등
- 불변 사항: 해당 코드 실행 전/후 항상 같아야 하는 것들

읽어보면 알겠지만, 이렇게 용어로 정리를 안해도 우리가 이미 하고 있는 것들에 내포된 개념임.

⇒ 우리가 입력 매개변수가 있는 함수를 작성하거나, 반환값이 있는 함수를 작성할 때 모두 이 계약을 생성한 것이 된다.

이런 계약 내용들을 알지 못하면 코드 계약에 문제가 발생할 수 있다. 그러므로, 어떻게 코드를 작성해야 이 코드를 사용하는 사람이 계약을 파악하고 따라갈 수 있을지 고민해야 한다.

### 계약의 명확한 부분

- 함수와 클래스 이름
- 인자 유형
- 반환 유형
- 검사 예외: 호출하는 코드가 이것을 처리하지 않으면 컴파일 되지 않는다고 명백하게 알려주는 것

세부조항  ⇒ 계약의 명확한 부분 외적으로 추가적으로 이 코드를 파악하는데 도움을 줄 수 있는 것들

- 주석문과 문서: 원래는 다 꼼꼼히 읽어야 하는것이 맞지만, 우린 실생활에서도 그렇게 꼼꼼히 계약서를 읽지 않는다. 그러므로 개발자는 이 사실을 염두에 두어야 한다
- 비검사 예외: 이 코드가 내부적으로 사용하는 함수가 비검사 예외를 생성하는데, 그걸 까먹고 이 코드 작성자가 알려주지 않은 경우

세부조항은 사람들이 잘 안읽고, 업데이트도 내가 잘 해줘야 한다.

그러므로, 세부조항에 의존하지 말고, 명확한 부분들을 더 신경써라.

### 세부조항

그럼에도 어쩔 수 없이, 세부조항에 의존해야 하는 경우가 있다. 예를 들어, 문제들에 주의사항이 있거나 설명해야 하는 경우. 또는 다른 사람이 작성한 이미 존재하는 저품질 코드에 내가 의존해야 하는 경우. 이 경우에는 내 코드가 어쩔 수 없이 이상하게 동작해야할 수 있다.

⇒ 이때는 이런 상황을 설명하는 문서화된 세부 조항이 필요하다.

그래도.. 너무 많이 문서화에 의존하지 말자.

### 세부조항이 너무 많은 코드 예시

페이지 68쪽 예제3.1 코드

getUiColor가 널 값을 반환하는 경우가, 세부조항을 읽지 않는다면, 유저가 설정한 색상이 없을 경우로 추론할 수 있다. 이는 잘못된 추론임. 왜냐하면 실제로는 설정이 로드되지 않은 경우에도 널을 반환하므로.

이렇게 잘못 추론한 개발자가 코드를 작성하면, 잠재적 버그가 있는 코드를 만들게 된다.

### 그렇다면 세부조항을 어떻게 제거할까?

잘못된 일을 처음부터 불가능하게 만드는 것이 가장 좋다

세부조항에 있는 어떤 항목에 대해 발생 자체가 불가능하도록 명백한 항목으로 바꾸는 것이 가능한 경우가 있다.

⇒ 코드가 오용되거나 잘못 설정되면 컴파일조차 되지 않도록 하는 것이 목표다.

- 초깃 세팅을 요구로 하는 클래스라면? 정적 팩토리 함수를 사용해서 초기화가 완전히 이루어진 인스턴스를 얻는 것만 가능하도록 수정할 수 있다. 만약 초기화 과정에서 실패를 하면, 널을 반환하는 방식으로 구성하면 됨.
    - 코드의 오용을 막을 수 있게 됨.

  ⇒ 이런 기법은, 상태나 가변성이 클래스 외부로 노출되는 것을 없애는 것임.


하지만, 위의 방법을 사용해도 완벽하진 않음. 널값을 반환하면 디버깅할 수 없기 때문임. 실패 이유에 대한 것을 잘못사용한 개발자에게 알려줄 수 있어야 함.

# 체크 및 어서션

컴파일러를 사용해서 애당초 계약 위반을 논리적으로 불가능하게 만드는 컴파일 타임 확인이 불가능한 경우에는, 런타임 검사를 통해 계약을 확인이라도 할 수 있게 해주는게 나을 수 있다.

즉, 체크 기법은 위에서 알아본 세부사항 제거는 아님. 단지, 세부사항을 읽도록 유도하는 것임.

### 체크

코드 계약이 준수되었는지 확인하기 위한 추가적인 로직임. 체크는 빠른 실패 와 연관이 있다.

- 전제 조건 검사: 입력 인수 상태 올바른지, 초기화 수행되었는지 유무 판단, 코드 실행 전 시스템이 유효한지 등의 계약 조건을 검사하는 것임.
- 사후 상태 검사: 반환값이 올바른지, 일부 코드 실행 후 시스템이 유효한지 등을 확인하는 경우

하지만, 체크 역시 예측하지 못한 경우 조건 위배가 배포 이후에 발생할 수 있다.

그러므로, 이런 체크에서 사용되는 예외의 경우 로그를 잘 기록해야 한다.

코드에 체크가 너무 많으면, 세부 조항을 없애야 하는 것은 아닌지 고민해라.

### 퍼즈 테스트

퍼즈 테스트는 여러 입력값에 대해서 그냥 다 테스트 돌리는 테스트 기법임.

이때, 체크와 함께 이 테스트를 사용한다면 효율성이 더 올라간다고 함.

퍼즈 테스트는 오류나 예외발생에 의존하는데, 체크는 해당 예외가 왜 발생했는지 명확히 알려주기 때문임.

### 어서션

어서션은 언어 차원에서 지원하는 것임.

어서션도 체크와 유사한데, 코드 계약을 준수하도록 강제하기 위한 기법임.

어서션과 체크 사이의 주요 차이점은 배포를 위해 빌드할 때 어서션은 보통 컴파일에서 제외된다.

즉, 어서션을 사용하면 배포환경에서 실패의 이유를 알 수 없다는 것임.

그렇다면, 왜 컴파일 단계에서 제거할까?

- 성능 향상을 위해: 코드에서 어서션이 많아지면 이것 또한 cpu를 잡아먹는 작업이다.
- 코드 오류 발생률을 낮추기 위해: 코드 오류 발생률을 낮추기 위해. 배포 환경에서 오류가 발생한다면, 사용자는 불편을 겪을 것임. 만약 버그 발생 가능성 방지보다 고가용성이 더 중요하다면 배포 시에 컴파일에서 제외하는 것이 더 좋을 수 있다.

하지만, 일부 개발 팀은 어서션도 배포 환경에 포함되도록 만드는 경우가 있다. 이 경우는 체크와 크게 다를게 없다고 함.

체크나 어서션을 사용하면 세부 조항을 읽도록 유도를 시켜주지만, 가능하면 애초에 세부 조항을 제거해라.
