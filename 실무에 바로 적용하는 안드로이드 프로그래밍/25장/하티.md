# Looper, Handler, HandlerThread

## Retrofit으로부터 데이터 내려받기

- 안드로이드는 main 스레드에서 네트워크 작업을 할 수 없다. 

  	-> `@WorkerThread` 애노테이션 추가 -> 백그라운드 스레드에서 호출되어야 함을 명시한다.

  	- `@MainThread`, `@UiThread`가 지정되면 main스레드에서 호출된다. 

- 백그라운드 스레드 생성, 백그라운드 스레드에서 함수를 호출하는 것 -> 백그라운드 스레드를 생성해서 호출해야 한다.
	- 스레드는 한번에 하나의 내려받기 요청을 받아 처리한다.
	
	- 클린업이나 스레드 중단을 쉽게 할 수 있다는 이점이 있다.
	
	- 별개로 비동기 요청을 보낸다면? 각 뷰 홀더, 프래그먼트 자체에 모든 Call 객체를 유지해야 한다.

## 백그라운드 스레드 만들기

- `HandlerThread`의 서브 클래스 생성
	+  `override quit()`: 스레드 종료를 위한 함수 
	
- 백그라운드의 생애는 해당 프래그먼트 생애와 연동해야 한다.
	+ 화면이 전환되는 등의 구성 변경이 발생한다면, 스레드를 소멸한 후 인스턴스를 보존해야 한다. (재생성 X)
		*  `retainInstance = true`
		
	- 프래그먼트, 뷰모델보다는 리포지터리 컴포넌트에서 스레드를 관리하는 것이 바람직하다.


- LifecycleObserver
	+ 생명주기 소유자의 생명주기를 관찰한다.
		+ 액티비티, 프래그먼트 등이 대표적인 예시!
	- **deprecated 되었다. 대안: DefaultLifecycleObserver, LifecycleEventObserver**

- HandlerThread 시작, 중단
	+ start() - looper - quit()
		* start()로 스레드를 시작한 후에 looper (Looper 인스턴스 참조) 를 사용한다.
		
		* quit()를 하지 않으면 스레드는 죽지 않고 살아있다..!
		

## 메시지와 메시지 핸들러

- 리마인드!
	+ UI 작업 - main thread
	
	- 시간이 오래 걸리는 작업 - background thread
	
- 메시지 큐에서 새로운 메시지를 찾기 위해 반복해서 메시지 루프를 실행한다!

- 메시지 큐: 스레드가 사용하는 메시지 수신함

- 메시지 루프: 메시지 큐를 사용해 동작하는 스레드
	+ 하나의 스레드 + 하나의 Looper
	
- Looper: 자신의 메시지 큐에 있는 메시지들을 꺼내어, 각 메시지가 지정하는 작업을 수행한다.
	+ 메시지 수신함을 소유한다.
	
### 메시지 구조

- what: 메시지를 나타내는 사용자 정의 정수 값

- obj: 메시지와 함께 전달되는 사용자 지정 객체

- target: 메시지를 처리할 Handler의 인스턴스

- 메시지는 자동으로 핸들러와 연결되며, Handler 객체가 메시지 처리를 한다.

- 메시지는 Looper에서 게시되고 소비된다.


### Handler 구조

- 메시지를 처리하는 대상이며, 메시지를 생성/게시하는 인터페이스

- 핸들러는 정확히 하나의 Looper에 연결되고 (Looper의 참조를 갖는다),
<br/> 메시지는 정확히 하나의 Handler에 연결된다.

- 다수의 Handler가 하나의 Looper에 연결될 수 있다.


### Handler 사용

- 메시지는 `Handler.obtainMessage(메시지 속성)` 를 호출하여 생성하는 것이 좋다.
	+ 새로운 메시지 객체 생성 X -> 공유되는 재활용 풀에서 메시지 객체를 가져다 사용한다.

- 일반적으로 Handler는 직접 설정하지 않고, 위의 함수가 호출된 Handler 객체를 대상 핸들러로 설정한다.

- Handler로 메시지를 전달하기 위해 `sendToTarget()`이 호출되고, 해당 메시지는 Looper의 메시지 큐 맨 끝에 들어간다.

- Looper는 메시지를 큐에서 꺼낸 후, 대상 Handler에게 전달해서 처리한다. (`Handler.handleMessage()`)



<br/>
<br/>

---

아직은 내용이 너무 방대하고 어렵다.
더 공부하고, 내공을 쌓은 뒤 다시 책을 펴봐야 할 것 같아요 ..!?! :(



